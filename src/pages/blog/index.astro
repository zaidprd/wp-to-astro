---
// src/pages/blog/index.astro
// REVISI FINAL LENGKAP

import { client, urlFor } from '../../lib/sanity';
import { blogSetting } from '../../data/config';
import PaginatedBlogLayout from '../../components/blog/PaginatedBlogLayout.astro';
export const prerender = true;

const currentPage = 1;

// Ambil semua postingan dari Sanity
const allPosts = await client.fetch(`
*[_type == "post"] | order(publishedAt desc) {
    title,
    "slug": slug.current,
    excerpt,
    "publishDate": publishedAt,
    "featuredImage": mainImage { asset->{...}, alt },
    categories[]->{ title }
}`);

// Logika Paginasi
const totalPosts = allPosts.length;
const postsPerPage = blogSetting.postsPerPage || 10;
const totalPages = Math.ceil(totalPosts / postsPerPage);
const paginatedPosts = allPosts.slice(0, postsPerPage);

// PERBAIKAN: Ubah struktur data agar cocok dengan yang dibutuhkan komponen `BlogPost.astro`
const postsForLayout = paginatedPosts.map(post => ({
    slug: post.slug, // Kirim slug secara langsung
    data: {
        title: post.title,
        excerpt: post.excerpt,
        publishDate: new Date(post.publishDate),
        categories: post.categories?.map(c => c.title) || [],
        featuredImage: post.featuredImage ? urlFor(post.featuredImage).width(800).url() : undefined,
    }
}));
---

<PaginatedBlogLayout
    posts={postsForLayout}
    currentPage={currentPage}
    totalPages={totalPages}
    baseUrl="/blog"
    title="Blog"
    subtitle="Latest articles and news from the team"
/>
