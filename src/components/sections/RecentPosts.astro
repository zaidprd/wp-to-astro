---
// src/components/sections/RecentPosts.astro (atau nama file yang sesuai)
// REVISI FINAL LENGKAP

import { client, urlFor } from '@lib/sanity'; // Impor dari Sanity
import BlogPost from '@components/blog/BlogPost.astro';
import Button from '@components/ui/Button.astro';
import Eyebrow from '@components/ui/Eyebrow.astro';
import { getPaddingClass, getBackgroundColor, getTextColor } from '@utils/styleUtils';
import type { PaddingSize, ThemeColor } from '@utils/styleUtils';

export interface Props {
    content?: {
        eyebrow?: string;
        title?: string;
        description?: string;
        button?: {
            text: string;
            link: string;
            variant?: 'primary' | 'secondary' | 'ghostLight' | 'ghostDark';
        };
    };
    background?: ThemeColor;
    padding?: PaddingSize;
    paddingTop?: PaddingSize;
    paddingBottom?: PaddingSize;
    postsToShow?: number;
    category?: string; // Nama kategori untuk difilter
}

const { content, background = 'base', postsToShow = 3, category } = Astro.props;

// Styling (sudah benar)
const bgColor = getBackgroundColor(background);
const textColor = getTextColor(background);
const paddingClass = getPaddingClass({
    padding: Astro.props.padding,
    paddingTop: Astro.props.paddingTop,
    paddingBottom: Astro.props.paddingBottom,
});

// --- PERBAIKAN UTAMA: Mengambil data dari Sanity ---
const allPosts = await client.fetch(`
*[_type == "post"] | order(publishedAt desc) {
    title,
    "slug": slug.current,
    excerpt,
    "publishDate": publishedAt,
    "featuredImage": mainImage { asset->{...}, alt },
    categories[]->{ title }
}`);

// Filter dan potong jumlah postingan (logika disesuaikan untuk data Sanity)
let filteredPosts = allPosts
    .filter((post: any) => !category || post.categories?.some((cat: any) => cat.title === category))
    .slice(0, postsToShow);
---

<section class:list={['relative', bgColor, paddingClass]}>
    <div class="site-container px-4">
        {
            (content?.title || content?.description) && (
                <div class="max-w-2xl mb-12">
                    {content?.eyebrow && <Eyebrow text={content.eyebrow} background={background} />}
                    {content?.title && <h2 class:list={[textColor]} data-aos="fade-up">{content.title}</h2>}
                    {content?.description && (
                        <p class:list={['mt-4', textColor, 'opacity-90']} data-aos="fade-up" data-aos-delay="100">
                            {content.description}
                        </p>
                    )}
                    {content?.button && (
                        <div class="mt-8" data-aos="fade-up" data-aos-delay="200">
                            <Button href={content.button.link} variant={content.button.variant || 'primary'}>
                                {content.button.text}
                            </Button>
                        </div>
                    )}
                </div>
            )
        }

        <div class="posts-grid">
            {
                filteredPosts.map((post: any, index: number) => (
                    <div>
                        {/* --- PERBAIKAN PENTING: Mengirim prop yang benar ke BlogPost --- */}
                        <BlogPost
                            title={post.title}
                            excerpt={post.excerpt}
                            featuredImage={post.featuredImage ? urlFor(post.featuredImage).width(600).url() : ''}
                            publishDate={new Date(post.publishDate)}
                            categories={post.categories?.map((cat: any) => cat.title) || []}
                            slug={post.slug}  // <-- Menggunakan `post.slug` bukan `post.id`
                            index={index}
                        />
                    </div>
                ))
            }
        </div>

        {filteredPosts.length === 0 && <p class="text-center text-gray-500 py-8">No posts found.</p>}
    </div>
</section>

<style>
    .posts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
    }
    @media (max-width: 768px) {
        .posts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
